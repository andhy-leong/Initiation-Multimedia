<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <title>Géolocalisation</title>
</head>
<body>
  <h1>TD1 - Géolocalisation</h1>

  <h2>getCurrentPosition()</h2>
  <ul>
    <li id="gcp-longitude">Longitude : null</li>
    <li id="gcp-latitude">Latitude : null</li>
    <li id="gcp-altitude">Altitude : null</li>
    <li id="gcp-precision">Précision : null</li>
    <li id="gcp-vitesse">Vitesse : null</li>
    <li id="gcp-timestamp">Timestamp : null</li>
  </ul>

  <h2>watchPosition()</h2>
  <ul>
    <li id="wp-longitude">Longitude : null</li>
    <li id="wp-latitude">Latitude : null</li>
    <li id="wp-altitude">Altitude : null</li>
    <li id="wp-precision">Précision : null</li>
    <li id="wp-vitesse">Vitesse : null</li>
    <li id="wp-timestamp">Timestamp : null</li>
  </ul>
  
  <p id="distance-marseille">Distance jusqu'à Marseille : ...</p>


  <div id="map" style="height: 400px; margin-top: 20px; border-radius: 8px;"></div>
  
 <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
 </script>

  <script>
    function remplir(prefix, position) {
      const c = position.coords;
      document.getElementById(prefix+'-longitude').textContent = 'Longitude : ' + c.longitude;
      document.getElementById(prefix+'-latitude').textContent = 'Latitude : ' + c.latitude;
      document.getElementById(prefix+'-altitude').textContent = 'Altitude : ' + (c.altitude ?? 'null') ;
      document.getElementById(prefix+'-precision').textContent = 'Précision : ' + c.accuracy + " m";
      document.getElementById(prefix+'-vitesse').textContent = 'Vitesse : ' + (c.speed ?? 'null') + " m/s" ;
      document.getElementById(prefix+'-timestamp').textContent = 'Timestamp : ' + new Date(position.timestamp).toLocaleString();
      updateMap(c.latitude, c.longitude, c.accuracy);

      const dist = haversine(c.latitude, c.longitude, marseilleCoords[0], marseilleCoords[1]);
      console.log("Distance vous à Marseille :", dist, "m");
      document.getElementById('distance-marseille').textContent = "Distance jusqu'à Marseille : " + (dist/1000).toFixed(2) + "km";

    }

    function erreur(prefix, err) {
      document.getElementById(prefix+'-longitude').textContent = 'Erreur : ' + (err.message || 'Inconnue');
    }

    const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        pos => remplir('gcp', pos),
        err => erreur('gcp', err),
        options
      );

      navigator.geolocation.watchPosition(
        pos => remplir('wp', pos),
        err => erreur('wp', err),
        options
      );
    } else {
      document.getElementById('gcp-longitude').textContent = 'La géolocalisation n\'est pas supportée par ce navigateur.';
      document.getElementById('wp-longitude').textContent = 'La géolocalisation n\'est pas supportée par ce navigateur.';
    }

    // Pour la carte
    const map = L.map('map').setView([0, 0], 2); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; OpenStreetMap contributors'}).addTo(map);
    //L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
    //  attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, ' +
    //              '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    //  subdomains: 'abcd',
    //  minZoom: 0,
    //  maxZoom: 20
    //}).addTo(map);


    let marker = null;
    let circle = null;

    // Coordonnées de marseille
    const marseilleCoords = [43.2965, 5.3698];

    // Ajout de Nice centre sur la map
    const niceCoords = [43.7000, 7.2667];
    L.marker(niceCoords).addTo(map).bindPopup("Nice").openPopup();

    // Tracer la ligne entre Nice et Marseille
    L.polyline([niceCoords, marseilleCoords], {
      color: 'blue',
      weight: 4,
      opacity: 0.8
    }).addTo(map)
      .bindPopup("Nice - Marseille");

    // Ajout d'un marqueur sur Marseille
    L.marker(marseilleCoords).addTo(map)
      .bindPopup("Marseille - Vieux Port");

    // Ajout du triangle des bermudes
    const TriangleBermudes = [
      [25.7617, -80.1918],   // Coordonnées Miami
      [18.4655, -66.1057],   // Coordonnées San Juan
      [32.3078, -64.7505]    // Coordonnées Bermudes
    ];

    L.polygon(TriangleBermudes, {
      color: 'red',
      fillColor: 'red',
      fillOpacity: 0.5}).addTo(map).bindPopup("Triangle des Bermudes");
    
    function updateStatus(message, isError = false) {
      console.log(message);
    }


    // Mise à jour du marqueur en fonction de la position actuelle
    function updateMap(lat, lon, accuracy) {
        const latlng = [lat, lon];
        map.setView(latlng, 16); // zoom sur la position
        if (marker) {
            marker.setLatLng(latlng); // déplace le marker 
        } else {
            marker = L.marker(latlng).addTo(map); // crée le marker pour la première fois
        }
        if (circle) {
            circle.setLatLng(latlng).setRadius(accuracy);
        } else {
            circle = L.circle(latlng, {
                radius: accuracy,       // rayon de précision en fonction de la précision
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.2
            }).addTo(map);
        }
        const dist = haversine(lat, lon, marseilleCoords[0], marseilleCoords[1]);
        marker.bindPopup("Distance entre vous à Marseille : "+(dist/1000).toFixed(2) + " km").openPopup();
      }

    // Fonction pour calculer la distance entre deux coordonnées
    function haversine(latitude1, longitude1, latitude2, longitude2){
      const rayonTerre = 6371e3; 
      const degresEnRadians = degres => degres * Math.PI / 180;

      const lat1Rad = degresEnRadians(latitude1);
      const lat2Rad = degresEnRadians(latitude2);
      const diffLat = degresEnRadians(latitude2 - latitude1);
      const diffLon = degresEnRadians(longitude2 - longitude1);

      const a = Math.sin(diffLat / 2) * Math.sin(diffLat / 2) + 
                Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                Math.sin(diffLon / 2) * Math.sin(diffLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return rayonTerre * c;
    }

    //Plage de nice GeoJSON
    fetch("https://opendata.nicecotedazur.org/data/storage/f/2021-02-16T09%3A58%3A34.356Z/plages.geojson")
        .then(res => res.json())
        .then(data => {
            L.geoJSON(data, {
                onEachFeature: (feature, layer) => {
                    layer.bindPopup("Plage : " + (feature.properties.nom || "inconnue"));
                },
                style: { color: "orange" }
            }).addTo(map);
        });

    //Utilisation d'une autre api "api gouv"
    fetch("https://geo.api.gouv.fr/departements?geometry=contour")
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: { color: "blue", weight: 2, fillOpacity: 0.1 },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(`Département : ${feature.nom}`);
        }
      }).addTo(map);
    })
    .catch(err => console.error("Erreur chargement départements:", err));


  </script>
</body>
</html>